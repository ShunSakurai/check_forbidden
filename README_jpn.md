# check_forbidden
memoQバイリンガルファイル(.mqxlz/.mqxliff)の訳文中に、禁止されている訳語が使用されているかどうかを確認するためのツールです。

[英語のREADME](https://github.com/ShunSakurai/check_forbidden/blob/master/README.md)もあります。

![UI](https://raw.github.com/wiki/ShunSakurai/check_forbidden/check_forbidden_ui.png)

## 説明
[memoQ](https://www.memoq.com/)では、用語ベースを使用した、禁止されている原語と訳語のペアの検証と、QA設定を使用した禁止語の検証が行えます。しかし、1つ1つ、設定を選びながら禁止語を追加していくのは、時間のかかる作業です。
このツールを使用すると、CSV形式の用語リストを使用して、memoQのバイリンガルファイルで使用されている禁止語を素早く絞り込み、特定することができます。正規表現(regex)を使用できます。外部のPythonスクリプトから訳文セグメントに対して関数を呼び出すこともできます。これにより、翻訳の品質を効率的に維持することができます。
(memoQの最近の[アップデート](https://www.memoq.com/memoq-build-june)で、禁止されている訳語のみを、対応する原語に関係なく検証することができるようになりました。用語ベースにCSVファイルをインポートできるように、QA設定でもCSVファイルをインポートできるようになることを期待しています。)

例えば、次のような状況でこのツールを使用できます。

- スタイルガイドにより、訳文中に「doesn't」や「can't」のような短縮系を使用できない場合
- スタイルガイドにより、半角文字と全角文字の間にスペースを使用できない場合
- JP (日本語):「次の/次に」は使用できるが、「以下の/以下に」は使用できない場合
- JP:「例えば」を漢字にする必要があり、「たとえば」は使用できない場合

必要なものは次のとおりです。

- memoQのバイリンガルファイル(.mqxlzまたは.mqxliff形式)
- 禁止語の一覧を含むCSVファイルまたはテキストファイル

このツールは、バイリンガルファイル中の禁止語を検索し、コマンドプロンプトに結果を表示し、さらに検索結果をCSVファイルにエクスポートします。コマンドプロンプトは、結果をざっと読み、検出された用語を簡単に確認するのに適しています。CSVファイルは、検出結果が多い場合や、バイリンガルファイルに多くの印字できない文字が含まれている場合に便利です。「ビュー」を使って作業している場合は、まとめ結果が便利です。

このプログラムは、Pythonとtkinterを使用してコーディングし、[py2exe](http://www.py2exe.org/)を使用して.exe形式で配布するものです。

アイコンは[アイコン ウィザード](http://freewareplace.web.fc2.com/)を、インストーラーは[Inno Setup](http://www.jrsoftware.org/isdl.php)を使用して作成しました。

## インストール
現在、Windowsにのみ対応しています。プログラムファイルは[Releases(リリース)](https://github.com/ShunSakurai/check_forbidden/releases)で入手できます。

インストーラーをダウンロードして実行するだけで、インストールやアップデートを行えます。

このプログラムが動作するには**フォルダーに含めたまま**にしておく必要があります。プログラム単体では動作しません。

Python環境をインストールしている場合、`python(3) check_forbidden.py`または`import check_forbidden`でソースコードをMacなど任意のOSで実行できます。

## ビルド
Pythonコードを.exeファイルに変換し、インストーラーを作成するには、次の手順に従います。

.exeファイルの要件と手順:

- Python 3.4(私の知る限り、py2exeはPython 3.5に対応していません)
- [py2exe](http://www.py2exe.org/)
- Windowsマシン上で`py -3.4 setup.py py2exe`を実行します

インストーラーの要件と手順:Requirements and procedures for the installer:

- [Inno Setup](http://www.jrsoftware.org/isdl.php)
- setup_installer.issをInno Setup Compilerで開き、Build(ビルド)>Compile(コンパイル)をクリックします。

## 使用方法

### 概要
- Check Forbidden.exeをダブルクリックしてプログラムを開きます
- 「Bilingual」(バイリンガル)をクリックするか、ファイルへのパスを入力するか貼り付けることで、バイリンガルファイルを選択します
- 禁止語の一覧を含むCSVファイルまたはテキストファイルを選択します
- エクスポートする結果ファイルのパスとファイル名を選択するか、チェックボックスを選択してエクスポートを無効にします。既定値は、1つ目のバイリンガルファイルのパス + "checked_result.csv"です
- 「Run!」(実行)をクリックします
- 結果はコマンドプロンプトに表示されます。一致する結果が見つかり、エクスポートが有効になっている場合は、CSVファイルにもエクスポートされます
- プログラムを閉じるには、「Enter」キーを押すか、「X」(閉じる)ボタンをクリックします

![結果](https://raw.github.com/wiki/ShunSakurai/check_forbidden/check_forbidden_result.png)

### ヒント
- 入力欄にパスを入力するか貼り付けたあとにファイルを選択するボタンを押すと、欄内のパスを初期パスとして参照します
- 入力欄にパスが記入されている場合、右の矢印を押してそのフォルダーを開くことができます
- 結果はファイルごとと、ファイル全体についての「Summary」(まとめ)として表示されます
- プログラムを開いたまま、何度も繰り返し実行できます
- 結果ファイルとして既存のCSVファイルを選択すると、結果はファイルの末尾に追加されます

### オプション
検索の対象とするセグメントの種類を指定できます。オプション画面を表示するには、歯車⚙アイコンをクリックします。画面を隠すには、三角▲アイコンをクリックします。

![オプション](https://raw.github.com/wiki/ShunSakurai/check_forbidden/check_forbidden_options.png)

### memoQファイルの種類
次の2種類のファイルに対応しています。

- .mqxliff
- .mqxlz

.mqxlzファイルは、document.mqxliffファイル、スケルトン(書式情報)、バージョン情報(場合により)を圧縮したファイルです。本プログラムでは、document.mqxliffをフォルダーに展開し、処理の終了後に削除しています。

### CSVファイルの形式
各項目はコンマで区切ります。ファイルはUTF-8でエンコードしてください。すべての用語が正規表現とみなされるため、正規表現で使用される特殊文字('('、')'、'['、']'、'.'、'\*'、'?'、'!' '.'、'*'、'?'、'!'など)は、バックスラッシュで**エスケープ**してください。

- **1列目**の用語が禁止語とみなされます
- 他の列を使用して、インデックス番号、原語、正しい訳語などの詳細情報を指定することができます

![CSV](https://raw.github.com/wiki/ShunSakurai/check_forbidden/check_forbidden_csv.png)

エクスポートされる結果のCSVファイルは、BOM付きのUTF-8(Pythonではutf-8-sig)でエンコードされ、コンマで区切られています。一部のプログラムでこのファイルを開く場合、エンコーディングに注意が必要です。

### 正規表現
- ASCIIの半角文字と、全角文字を含むASCIIの半角文字以外のすべての文字との間にあるスペースを検索するには、[0-9A-Za-z]\s[^!-~]と[^!-~]\s[0-9A-Za-z]を追加します
- 隣にスペースのない括弧を検索するには、\\)\Sを追加します
- 現在memoQのタグの正規表現(\tag)はサポートされていません

### 外部関数の呼び出し
関数のチェックボックスを選択すると、外部のPythonスクリプトから訳文セグメントに対して関数を呼び出すことができます。

- 外部のPythonスクリプト内の「Function」という名前の関数を呼び出します。この関数は、セグメントID(整数)および訳文セグメント(文字列)を引数として取るものです
- この関数は、各セグメントに対してリストのリストを返すようにしてください。内側のリスト1つは、コマンドプロンプト上およびCSVファイル中の結果表示において1行で表示されます

コード例:
calculate_width.py
```
import re
pattern_half_width = re.compile(r'[ -~]')

def function(seg_id, target):
    length_half = len(re.findall(pattern_half_width, target))
    length_full = len(target) - length_half
    length_total = length_half + length_full * 2
    return [[seg_id, target, length_full, length_half, length_total]]
```

### キーボードショートカット
キーボードで下線の付いた文字を押すことで、ボタンやラジオボタンを選択することができます。下線の付いていないその他のボタンについては、次のキーで呼び出すことができます。

- Run!: スペースバー
- オプションの表示/非表示: Oキー
- エクスポート方法チェックボックスのオン/オフ: Cキー
- 関数チェックボックスのオン/オフ: Fキー
- フォルダーを開く: ショートカットキーなし

Enter(Return)キーは、フォーカスされたウィジェットを呼び出すために使用できます。

カーソルが入力欄内にある場合、キーボードショートカットは無効になります。これにより、欄に文字を直接入力できます。

## よくある質問への答え、既知の問題と対処法

### 単語の区切りが考慮されない
本プログラムでは、各セグメントを単なる文字列として扱います。各単語は区別しません。

- 「play」は「playing」とも「display」とも一致します

### 大文字と小文字は区別される
本プログラムでは、大文字と小文字は区別されます。必要な場合には、用語をCSVファイルに追加するとき、大文字と小文字の両方で追加してください。

### コマンドプロンプトが文字化けする
Windowsのコマンドプロンプトでマルチバイト文字が文字化けしているように見える場合があります。タイトルバーを右クリックし、「プロパティ/フォント」を選択し、フォントサイズを大きくするか別のフォントを選択すると、この問題が解決します。Alt + スペース、Pを順番に押すと、プロパティを素早く開くことができます。

![文字化け](https://raw.github.com/wiki/ShunSakurai/check_forbidden/check_forbidden_garbled.png)

### _extractフォルダーが削除されない
.mqxlzファイルを開く際に、_extractフォルダーが作成されます。エラーが発生すると、プログラムによってそのフォルダーが削除されない場合があります。そのような場合、お手数ですがご自身で削除をお願いします。

### &、>、<の記号が、memoQにより特殊文字エンティティに変換される
- &、;、などを追加しないようにします
- &、>、<の代わりに`&amp;`、`&gt;`、`&lt;`を使うようにします
- <が正規表現の後方参照(?<=)で使用されている場合は問題ありません。

### CSVファイルに特定の特殊文字が含まれていると、エラーが発生する
- CSVファイルにコンマが含まれている場合、区切り文字として解釈されてしまう可能性があります
- CSVファイルにアクセント記号の付いた文字が含まれている場合、それらの文字は検証のために正常に使用されますが、コマンドプロンプトには正常に印字されません
- CSVファイルに次の文字が含まれている場合、プログラムによりエラーが発生します: μ
- 次の文字は、問題なく扱うことができます: ©、®、™

### 誤検出
誤検出を防ぐための工夫を次に示します。

- 「display」との一致を防ぐには、CSVに「 play」または「\splay」(半角スペース + play)を追加します
- 例えば「等」(など)が「等級」と一致しないように、短すぎる用語を使用しないようにします
- 1つの用語に対して多くの誤検出が発生する場合、CSVファイルを分割することも検討してください

### Summary結果が順番に表示されない
Pythonの集合型オブジェクトを使用して結果をまとめています。そのため、まとめ結果が正しい順番で表示されないという問題が発生しています。今後、この問題の解決に向けて取り組みます。

###検索に時間がかかりすぎる場合の対処法
- 100%/101%マッチを除外するオプションの使用を検討します
- 複数のドキュメント(ファイル)に対してビューの作成を検討します

## 今後追加予定の機能
### 開発中の機能
- コードの[リーダブル](http://www.amazon.co.jp/dp/4873115655)化
- まとめ結果を並び替えて整列
- 画面の大きさの自由変更
- 「ファイルを開く」ダイアログの使いやすさを改善
- 結果の表示とフィルターのできるtk画面を作成

### 棚上げ中の機能
- バイリンガルファイル欄の{波かっこ}を非表示
- CSVの区切り文字を指定するための設定を追加
- memoQ以外のファイルへの対応
- [Microsoftスタイルガイド](https://www.microsoft.com/Language/ja-JP/StyleGuides.aspx)の禁止語リストを例として作成
- 外部プログラムからの呼び出しに対応

### 追加予定のない機能
- ドラッグでファイルを追加。tkinterでドラッグアンドドロップ機能を使用するのは難しいため
- 誤検出をマークして無視。技術的に難しいため
- 禁止語の列を指定するための設定を追加
- 用語一覧内にエスケープされていない文字が含まれる場合に警告。`&lt;`と<との区別がつけられないため
- 複数のバイリンガルファイルを別のフォルダーから選択する機能を追加。あまり重要でないため

すぐに使用したい機能がある場合は[ご連絡ください](https://app.asana.com/-/share?s=132227284282305-bvBtn99BajlghI1nePsyD62jRMGpbZdaHxdnO7Qps8Y-29199191293549)。

## 履歴
文頭の「*」は、バグ修正を示します。
履歴の詳細は、[Releases(リリース)](https://github.com/ShunSakurai/check_forbidden/releases)でご覧ください。

### v1.8.3、2016年9月29日
- 更新の適用後、インストーラーを削除(コマンドラインのみ)
- * バージョン同士が正しく比較されない問題を解決

### v1.8.1、2016年9月23日
- 使いやすさを改善

### v1.8.0、2016年9月21日
- 複数の用語リストファイルをサポート
- テストを半自動化
- クロス翻訳されたセグメントをサポート
- 読みやすさを改善

### v1.7.2、2016年9月1日
- オンラインでアップデートを確認してダウンロード
- * 過去の訳が検索範囲に含まれる問題を解決

### v1.7.0、2016年8月21日
- 訳文セグメントに対して外部のPython関数を呼び出し
- 空白のセグメント<target xml:space="preserve"></target>を除外
-  UI要素にカーソルを合わせた際にショートカットキーを表示

### v1.6.8、2016年7月29日
- 結果ファイルにBOMを付けることで、Excelによる文字化け表示を防止
- shutilモジュールを使用してセットアップを半自動化

### v1.6.7、2016年7月27日
-  検出された一致の数を表示
- 訳文セグメントが印字できない場合にもセグメントIDを表示

### v1.6.5、2016年7月19日
- 速度を計測
- 読みやすさを改善し、バグを修正
- ファイルを反復的に読み込むことで、メモリの使用量を削減
- * スラッシュの置換が正常に動作しない問題を解決

### v1.6.1、2016年7月4日
- インストーラーを作成

### v1.6.0、2016年6月30日
- 結果にmemoQのセグメントIDを表示
- デザインをわずかに改善し、バグを修正

### v1.5.10、2016年6月23日
- プログラム内からフォルダーを開くボタンを追加
- バージョン番号を表示
- コードのリーダブル化
- * 特殊文字を画面に表示する際に失敗する問題を再解決

### v1.5.6、2016年6月21日
- * バイリンガルファイル中の改行しないスペースによるエラーを回避

### v1.5.5、2016年6月14日
- アイコンを作成

### v1.5.4、2016年6月8日
- * 特殊文字を画面に表示する際に失敗する問題を解決

### v1.5.3、2016年6月6日
- CSVファイルの見出し行を表示
- * 結果ファイルのパス候補が表示されない問題を解決
- * Resultボタンが無効なときでも押せてしまう問題を解決

### v1.5.0、2016年6月1日
- 禁止語の場所をCSVファイルまたはテキストファイルの1列目に統一
- 禁止語一覧での正規表現の対応
- コンテキストを含めて結果を表示
- 'Command Prompt only.'(コマンドプロンプトのみ)をデフォルトに変更
- 連絡先情報を追加

### v1.4.16、2016年5月12日
- Pythonの推奨事項を反映
- memoQへのリンクを追加
- * 結果ファイルのパスに関係する問題を解決
- * バイリンガルファイルのパスに関係する問題を解決

### v1.4.14、2016年5月6日
- 検索からタグを除外
- バイリンガルファイル欄にパスを入力または貼り付ける場合も、エクスポートする結果ファイルのパスとファイル名候補を表示
- 入力欄のパスを、ボタンを押したときの初期パスに設定
- * テストケースを作成し、いくつかの問題を解決

### v1.4.10、2016年5月1日
- エクスポート方法(コマンドプロンプト/CSVファイル)を選択するためのチェックボックスを追加
- ファイルを開くダイアログをキャンセルした場合に入力欄の内容を保持

### v1.4.8、2016年4月29日
- * 改行タグが訳文セグメントに含まれている場合に検索が失敗する問題を解決

### v1.4.7、2016年4月28日
- 検索結果の上部に、現在時刻、CSVファイルの名前、使用したオプションを表示
- Return(Enter)キーに、各ウィジェットのイベントを割り当て
- * 結果CSVファイルがすでに開かれている場合にフォルダーが削除されない問題を解決

### v1.4.4、2016年4月28日
- プログラムを初めて使うユーザーに向けた情報を追加
- カーソルが入力欄内にある場合、キーボードショートカットを無効化
- 2つ目のボタンの名前を「CSV」から「Terms」に変更
- * filetypes引数が複数の場合にMacでファイルを選択できなくなる問題を解決

### v1.4.0、2016年4月23日
- アプリケーションの名前を「Check Forbidden」に変更
- 結果ファイルのファイル名の末尾に.csvを必ず追加
- distフォルダーのサイズを縮小
- .mqxlzファイルと.mqxliffファイルを同時選択
- 起動時のメッセージを追加
- * 既知の問題を追加:タグや特殊文字に使用されている1文字の記号を使用しないようにします

### v1.3.0、2016年4月12日
- オプションアイコンを変更
- キーボードショートカットを追加
- 101%マッチと100%マッチを除外する機能を追加
- ロックされたセグメントを除外する機能を追加
- オプションを表示するための、拡張画面を作成
- 各ボタンのテキストガイドを追加、統一
- エクスポートされるCSVファイル中のまとめ結果の後に改行を追加
- スクリプト部分とUI部分を分割(UI部分がメイン)
- * WorldServerからエクスポートされたバイリンガルファイルに付加されるTMエントリを検索から除外
- * Runボタンが無効なときでも押せてしまう問題を解決

### v1.1.3、2016年4月7日
- CSVファイル中のまとめ結果を分割
- distフォルダー内のファイルの数を削減
- ボタン名と、エクスポートするCSVファイルのデフォルト名を変更
- * 既知の問題を追加:マルチバイト文字の文字化けを修正するには、コマンドプロンプトのフォントを変更します

### v1.1.0、2016年3月31日
- バイナリファイルを配布
- デザインをわずかに改善
- README_jpn.mdを作成

### v1.0.10、2016年3月28日
- 言語ペアを英->日からより一般的な原語->訳語に変更
- README.mdを作成
- * バイリンガルファイルの解析時に正規表現を使用するため、バイリンガルファイルの選択肢から.txt形式を削除

### v1.0.9、2016年3月24日
- * 禁止語が見つからない場合にフォルダーが削除されない問題を解決

### v1.0.8、2016年3月24日
- GitHubに追加

### v1.0.0、2016年3月22日
### v0.9.0、2016年3月17日
- 社内で使用開始

### 2015年12月8日
- [Pythonの入門書](http://www.amazon.co.jp/dp/4797371595)を購入

### 2015年7月30日
- 発案

## 貢献
これは個人的なプロジェクトにすぎませんが、どんな[ご意見](https://app.asana.com/-/share?s=132227284282305-bvBtn99BajlghI1nePsyD62jRMGpbZdaHxdnO7Qps8Y-29199191293549)や貢献でもいただけると幸いです。

同僚の翻訳者やPMの皆さん、このページの英語や訳語を自然な文にするお手伝いをしていただけたら幸いです。

## 使用権限
このツールは無料でお使いいただけます。

© 2016 Shun Sakurai
